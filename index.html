<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="en" class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width = 1050, user-scalable = no" />

  <title>Le Carnet de Voyage de l'Oncle Ernest</title>

  <link href='https://fonts.googleapis.com/css?family=Kurale' rel='stylesheet' type='text/css'>

  <script type="text/javascript" src="assets/lib/turnjs4/extras/jquery.min.1.7.js"></script>
  <script type="text/javascript" src="assets/lib/turnjs4/extras/modernizr.2.5.3.min.js"></script>
  <script type="text/javascript" src="assets/lib/turnjs4/extras/jquery.mousewheel.min.js"></script>
  <script type="text/javascript" src="assets/lib/turnjs4/extras/modernizr.2.5.3.min.js"></script>
  <script type="text/javascript" src="assets/lib/turnjs4/lib/hash.js"></script>
  <script type="text/javascript" src="assets/lib/turnjs4/lib/turn.min.js"></script>
  <script type="text/javascript" src="assets/lib/paper-core.min.js"></script>
  <script type="text/javascript" src="assets/lib/paper-full.min.js"></script>
  <script type="text/javascript" src="assets/lib/jquery-ui.min.js"></script>

  <script type="text/javascript" src="assets/js/textPage.js"></script>
  <script type="text/javascript" src="assets/js/syntheseTrame.js"></script>
  <script type="text/javascript" src="assets/js/syntheseTrameFinal.js"></script>
  <script type="text/javascript" src="assets/js/synthesePage.js"></script>

  <script type="text/javascript" src="assets/js/soufflePoussiere.js"></script>
  
  <script type="application/javascript" src="assets/lib/headtrackr.min.js"></script>
  <script type="text/javascript" src="assets/js/photoBAM.js"></script>
  <script type="application/javascript" src="assets/lib/volume-meter.js"></script>
  
  <script type="application/javascript" src="assets/lib/annyang.min.js"></script>
  
  <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>
  
  <button id="btnSkip">SKIP</button>
  
  <div id="story">
    <audio id="audio" controls="controls">
      <source id="mp3Source" src="" type="audio/mpeg"></source>
      Your browser does not support the audio format.
    </audio>

    <div id="menu">
      <a id="btnStart" href="#">Lire</a>
      <div id="panier">
        <img id="tartePan" class="alPan" src="assets/pages/page_2/tarte.png">
        <img id="cremePan" class="alPan" src="assets/pages/page_3/creme.png">
        <img id="sucrePan" class="alPan" src="assets/pages/page_4/sucre.png">
        <img id="cacaoPan" class="alPan" src="assets/pages/page_5/cacao.png">
      </div>
    </div>

    <div id="cycler">
      <img class="active" src="assets/trames/trame1.png">
      <img src="assets/trames/trame2.png">
      <img src="assets/trames/trame3.png">
    </div>

    <div id="clic_carton"></div>

    <div class="flipbook-viewport">
      <div class="container">
        <div class="flipbook">
          <div style="background-image:url(assets/bookCover.png)"></div>
          <div style="background-image:url(assets/pages/page_1/page1.1.png)"></div>
          
          <div style="background-image:url(assets/pages/page_1/page1.2.png)"></div>
          
          <div style="background-image:url(assets/pages/page_2/page2.1.png)">
          	<img id="tarte" class="al" src="assets/pages/page_2/tarte.png">
          </div>
          
          <div style="background-image:url(assets/pages/page_2/page2.2.png)">
            <img id="cactus" class="ui-widget-content" src="assets/pages/page_2/cactus1.png">
            <img id="cactus_coupe" src="assets/pages/page_2/cactus2.png">
            <img id="stick" class="ui-widget-content" src="assets/pages/page_2/stick.png">
          </div>
          
          <div style="background-image:url(assets/pages/page_3/page3.1.png)"></div>
          
          <div style="background-image:url(assets/pages/page_3/page3.2.png)">
            <canvas id="canvas_clapclap"></canvas>
            <img id="clapclap" src="assets/pages/page_3/clapclap.png">
          	<img id="creme" class="al" src="assets/pages/page_3/creme.png">
          </div>
          
          <div style="background-image:url(assets/pages/page_4/page4.1.png)">
          	<img id="sucre" class="al" src="assets/pages/page_4/sucre.png">
          </div>
          
          <div style="background-image:url(assets/pages/page_4/page4.2.png)">
            <img id="bam" src="assets/pages/page_4/BAM.png">
            <img id="petitApp" src="assets/pages/page_4/petitApp2.png">
            <canvas id="appareil" width="200" height="300"></canvas>
            <canvas id="compare" width="320" height="240" style="display:none"></canvas>
            <video id="vid" autoplay loop width="320" height="240"></video>
            <canvas id="overlay" width="320" height="240"></canvas>
            <canvas id="snapshot" width="320" height="240"></canvas>
            <img id="mask" src="assets/pages/page_4/helmet.png" style="display:none;">
            <img id="bam" src="assets/pages/page_4/BAM.png" style="display:none;">
          </div>
          
          <div style="background-image:url(assets/pages/page_5/page5.1.png)">
          	<img id="cacao" class="al" src="assets/pages/page_5/cacao.png">
          </div>
          
          <div style="background-image:url(assets/pages/page_5/page5.2.png)">
            <img id="gladyss_laby" src="assets/pages/page_5/GladyssLaby.png">
          </div>
          
          <div style="background-image:url(assets/pages/page_6/page6.1.png)">
            <img id="miam" src="assets/pages/page_6/finaltarte.png">
            
          </div>
          
          <div style="background-image:url(assets/pages/page_6/page6.2.png)">
            <img id="key" src="assets/pages/page_6/key.png">
            <img id="tonton" src="assets/pages/page_6/oncle.png">
            <img id="ninja" src="assets/pages/page_6/ninja.png">
          </div>
          
        </div>
      </div>
    </div>

    <div id="divsubtitles">
      <p id="sub"></p>
    </div>
    <canvas id="clone" width="320" height="240"></canvas>
  </div>
  

  <script type="text/javascript" src="assets/js/basic.js"></script>

	<script type="text/paperscript" canvas="canvas_clapclap">
		var path;

		tool.minDistance = 20;

		function onMouseDown(event) {
			if (path) {
				path.selected = false;
			};
			path = new Path();
			path.strokeColor = 'black';
			path.fullySelected = true;
		}

		function onMouseDrag(event) {
			path.add(event.point);
		}

		function onMouseUp(event) {
			path.selected = false;
			path.smooth();
		}
	</script>

  <script type="text/javascript">
    function cycleImages(idNextTrame) {
      var $active = $('#cycler .active');

      // var $next = ($active.next().length > 0) ? $active.next() : $('#cycler img:first');
      var $next = ($active.next().length > 0) ? $active.next() : $('#cycler').fadeOut();
      $next.css('z-index', -2); //move the next image up the pile

      $active.fadeOut(1500, function () { //fade out the top image
        $active.css('z-index', -3).show().removeClass('active'); //reset the z-index and unhide the image
        $next.css('z-index', -1).addClass('active'); //make the next image the top one
        if(!finLivre){
          speakTrame(idNextTrame, 0, utterance);
        }else{
          console.log('fin');
        }
      });
      
      if(!finLivre){
        if (!($active.next().length > 0)) {
          $('.flipbook').fadeIn();
          loadApp();
        }
      }
    }

    function loadApp() {
      $('.flipbook').turn({
        width: 922,
        height: 600,
        elevation: 0,
        gradients: true,
        autoCenter: true,
      });

      $('.flipbook').bind('turned', function (event, page, view) {
//        console.log('Page: ' + page);

        if (page === 2) {
          if(finLivre){
            pourAliment();
          }else{
            dialPage(0);
          }
        }

        if (page === 4) {
          // premiere partie du dialogue de la page 2
          dialPage(1);
          
          if(finLivre){
            pourAliment();
          } else {
            if ($('#cactus').css('display') !== 'none') {
              $(".flipbook").turn("disable", true);

              $('#stick').draggable();

              $('#cactus').droppable({
                drop: function (event, ui) {
                  $(this).fadeOut();
                  $('#stick').fadeOut();
                  $(".flipbook").turn("disable", false);
                  dialPage(3);
                }
              });
            }
          }
        }

	    if (page === 6) {
        if(finLivre){
          // TODO
          pourAliment();
        } else {
          $(".flipbook").turn("disable", true);

          dialPage(4);
    //	    	$('#canvas_clapclap').fadeIn('slow');
          $('#clapclap').hover(function(){
            $(this).effect('shake');
            $(this).css('opacity','1');
          });
        }
	    }
        
      if(page === 8){
        if(finLivre){
          // TODO
          pourAliment();
        }else{
          $(".flipbook").turn("disable", true);

          dialPage(7);      
        }
      }
        
      if (page === 10) {
        if(finLivre){
          // TODO
          pourAliment();
        } else {
          $(".flipbook").turn("disable", true);
          dialPage(11);
          var i = 0;

          if (annyang) {

            var laby = [
              {direction: 'right', top: '11em', left: '18em'},
              {direction: 'down', top: '18em', left: '18em'},
              {direction: 'left', top: '18em', left: '4em'},
              {direction: 'down', top: '22em', left: '4em'},
              {direction: 'right', top: '22em', left: '11em'},
              {direction: 'down', top: '32em', left: '10em'},
            ];

            var commands = {
              'Left': function() {
                if (i === 2) {
                  $('#gladyss_laby').fadeOut();
                  $('#gladyss_laby').css('top', laby[i].top).css('left', laby[i].left).fadeIn();
                  i++;
                }
              },

              'Right': function() {
                if (i === 0) {
                  $('#gladyss_laby').fadeOut();
                  $('#gladyss_laby').css('top', laby[i].top).css('left', laby[i].left).fadeIn();
                  i++;
                  dialPage(12);
                }

                if (i === 4) {
                  $('#gladyss_laby').fadeOut();
                  $('#gladyss_laby').css('top', laby[i].top).css('left', laby[i].left).fadeIn();
                  i++;
                }
              },

              'Down': function() {
                if (i === 1) {
                  $('#gladyss_laby').fadeOut();
                  $('#gladyss_laby').css('top', laby[i].top).css('left', laby[i].left).fadeIn();
                  i++;
                }

                if (i === 3) {
                  $('#gladyss_laby').fadeOut();
                  $('#gladyss_laby').css('top', laby[i].top).css('left', laby[i].left).fadeIn();
                  i++;
                }

                if (i === 5) {
                  $('#gladyss_laby').fadeOut();
                  $('#gladyss_laby').css('top', laby[i].top).css('left', laby[i].left).fadeIn();
                  i++;
                  // gladyss est arrivée
  //                dialPage(12);
                }
              },
            };
            annyang.addCommands(commands);
            annyang.start();
          }
        }
      }
        
        if(page === 12){
          if(finLivre){
            if(panier.length === 4){
              $(".flipbook").turn("disable", true);
              
              // todo faire apparaitre tarte
              $('#miam').fadeIn();
              
              dialPage(14);
              
              $('#key').draggable();

              $('#ninja').droppable({
                drop: function (event, ui) {
                  $(this).hide();
                  $(this).css('opacity', '1');
                  $(this).fadeIn();
                  $('#tonton').fadeIn();
                  $('#key').fadeOut();
                  dialPage(15);
                }
              });
            }
          } else {
            $(".flipbook").turn("disable", true);

            dialPage(13);
          }
        }
        
      });
    }

    $('#clic_carton').click(function () {
      $(this).hide();
      cycleImages(2);
    });

    $(document).ready(function () {
      // setInterval('cycleImages()', 7000);
      // loadApp();
    });

    function majSubtitles(text, quiParle) {
      $('#sub').text(quiParle + ' : ' + text);
    }

    var utterance = new SpeechSynthesisUtterance();
    
    var finLivre = false;
    
    var panier = [];
    var tabImgAl = [];

    window.onload = function () {
      window.speechSynthesis.onvoiceschanged = function () {
        // affiche les voix dispo de Google
        //        window.speechSynthesis.getVoices().forEach(function (voice) {
        //          console.log(voice.name, voice.default ? '(default)' : '');
        //        });
        utterance.voice = window.speechSynthesis.getVoices()[7];
        utterance.lang = "fr-FR";
        //        console.log(window.speechSynthesis.getVoices());
      }
      $('#btnStart').on('click', function () {
        speakTrame(0, 0, utterance);
        $(this).hide();
        $(this).off('click');
        //                cycleImages();
      });
      
      $('#btnSkip').on('click', function() {
        skip();
      });
      
      tabImgAl = $('.al');
    }
    $('#canvas_clapclap').hide();
    
    function cloneCanvas(oldCanvas) {

      //create a new canvas
      var newCanvas = document.createElement('canvas');
      var context = newCanvas.getContext('2d');

      //set dimensions
      newCanvas.width = oldCanvas.width;
      newCanvas.height = oldCanvas.height;

      //apply the old canvas to the new one
      context.drawImage(oldCanvas, 0, 0);

      //return the new canvas
      return newCanvas;
    }
    
    function skip(){
      $('.flipbook').fadeOut('slow');
      dialPage(15);
    }
  </script>
</body>

</html>